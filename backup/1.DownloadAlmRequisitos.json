{
  "name": "1.DownloadAlmRequisitos",
  "nodes": [
    {
      "parameters": {},
      "id": "3c8f85db-76a9-4a6c-8997-bb4c0a56019d",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "position": [
        -1344,
        56
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mcp-alm-inovaigmjsp.np.bsa.estaleiro.serpro.gov.br/mcp/mcp",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Basic MDUzMTIwOTc5MjY6VHJhYmFsaG9yZW1vdG8wMQ=="
            },
            {
              "name": "Accept",
              "value": "application/json, text/event-stream"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"jsonrpc\": \"2.0\",\n  \"id\": 1,\n  \"method\": \"tools/call\",\n  \"params\": {\n    \"name\": \"consultar_areas_de_projeto\",\n    \"arguments\": {}\n  }\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "text"
            }
          }
        }
      },
      "id": "c59a20ba-7bb1-4828-a750-cebfc6fa8f7b",
      "name": "Consultar Areas",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -1120,
        56
      ],
      "typeVersion": 4.3
    },
    {
      "parameters": {
        "jsCode": "const raw = $input.first().json.data;\nconst line = raw.split('\\n').find(l => l.startsWith('data: '));\nconst rpc = JSON.parse(line.replace('data: ', ''));\nconst text = rpc.result.content[0].text;\n\nconst areas = JSON.parse(text);\n\n// nome exato da Ã¡rea\nconst NOME_AREA = 'SINESP-PPE (Gerenciamento de Requisitos)';\n\n// filtra aqui\nconst area = areas.find(a => a.nome === NOME_AREA);\n\n// se nÃ£o achar, falha explÃ­cita\nif (!area) {\n  throw new Error(`Ãrea nÃ£o encontrada: ${NOME_AREA}`);\n}\n\n// retorna somente a Ã¡rea desejada\nreturn [{ json: area }];\n"
      },
      "id": "b2d6d0f5-eb9e-4940-8880-6bbbb206f5c9",
      "name": "Parse Areas SSE",
      "type": "n8n-nodes-base.code",
      "position": [
        -896,
        56
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mcp-alm-inovaigmjsp.np.bsa.estaleiro.serpro.gov.br/mcp/mcp",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Basic MDUzMTIwOTc5MjY6VHJhYmFsaG9yZW1vdG8wMQ=="
            },
            {
              "name": "Accept",
              "value": "text/event-stream, application/json"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"id\": 1,\n  \"method\": \"tools/call\",\n  \"params\": {\n    \"name\": \"listar_requisitos_doors_next\",\n    \"arguments\": {\n      \"project_area_id\": \"{{ $json.id }}?oslc_config.context=https://alm.serpro/rm/cm/stream/__q31oAOEEeiiCL9T4NHyOQ\"\n    }\n  }\n}",
        "options": {
          "response": {}
        }
      },
      "id": "b2205ab3-6fab-4938-a741-0cf69439e9d7",
      "name": "Listar Requisitos",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -672,
        56
      ],
      "typeVersion": 4.3
    },
    {
      "parameters": {
        "jsCode": "const out = [];\n\nfor (const item of $input.all()) {\n  const raw = item.json.data;\n\n  const match = raw.match(/data:\\s*(\\{.*\\})/s);\n  if (!match) continue;\n\n  const rpc = JSON.parse(match[1]);\n  const text = rpc.result.content[0].text;\n  const requisitos = JSON.parse(text);\n\n  for (const r of requisitos) {\n    out.push({ json: r });\n  }\n}\n\nreturn out;\n"
      },
      "id": "00ceb027-f275-442e-a19f-4ee61e7cac3c",
      "name": "Parse Requisitos",
      "type": "n8n-nodes-base.code",
      "position": [
        -448,
        56
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Basic MDUzMTIwOTc5MjY6VHJhYmFsaG9yZW1vdG8wMQ=="
            },
            {
              "name": "Accept",
              "value": "*/*"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 10
            }
          },
          "allowUnauthorizedCerts": true,
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "4246ff2f-e993-4b62-abc7-9da686b547ce",
      "name": "Buscar Artefato",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        0,
        -16
      ],
      "typeVersion": 4.3
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nfor (const item of items) {\n  const ct =\n    item.binary?.data?.mimeType ||\n    item.json?.headers?.['content-type'] ||\n    '';\n\n  let ext = 'bin';\n\n  if (ct.includes('pdf')) ext = 'pdf';\n  else if (ct.includes('zip')) ext = 'zip';\n  else if (ct.includes('png')) ext = 'png';\n  else if (ct.includes('jpeg') || ct.includes('jpg')) ext = 'jpg';\n  else if (ct.includes('markdown')) ext = 'md';\n  else if (ct.includes('text/plain')) ext = 'txt';\n  else if (ct.includes('html')) ext = 'html';\n  else if (ct.includes('xml')) ext = 'xml';\n\n  item.json.__fileName = `${item.json.title}.${ext}`;\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        -16
      ],
      "id": "5f5968c1-6705-4593-a32b-c8d9b6a68c1a",
      "name": "tratar artefatos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://mcp-alm-inovaigmjsp.np.bsa.estaleiro.serpro.gov.br/mcp/mcp",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Basic MDUzMTIwOTc5MjY6VHJhYmFsaG9yZW1vdG8wMQ=="
            },
            {
              "name": "Accept",
              "value": "application/json, text/event-stream"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"id\": 1,\n  \"method\": \"tools/call\",\n  \"params\": {\n    \"name\": \"buscar_artefato_de_requisito\",\n    \"arguments\": {\n      \"resource_id\": \"{{ $json.resource_id }}\"\n    }\n  }\n}",
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 600
            }
          },
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        896,
        -16
      ],
      "id": "0c85205c-7ce7-4d3f-a105-72e032173343",
      "name": "download artefatos"
    },
    {
      "parameters": {
        "jsCode": "// listar arquivos sem extensão:\n// Get-ChildItem | Where-Object { -not $_.Attributes.HasFlag([System.IO.FileAttributes]::Directory) -and $_.Extension -eq \"\" }\nconst fs = require('fs');\nconst path = require('path');\n\nconst baseDir = '/home/node/.n8n-files/requisitos/raw/';\nif (!fs.existsSync(baseDir)) fs.mkdirSync(baseDir, { recursive: true });\n\nfunction extractUrls(text) {\n    const urlRegex = /(https?:\\/\\/[^\\s\"'<>]+)/g;\n    return text.match(urlRegex) || [];\n}\n\nconst items = $input.all();\nconst returnItems = [];\n\nfor (const item of items) {\n    const rawData = item.json.data;\n    try {\n        const jsonMatch = rawData.match(/data:\\s*({.*})/s);\n        if (!jsonMatch) continue;\n\n        const parsed = JSON.parse(jsonMatch[1].trim());\n        const artefato = parsed.result.structuredContent.result;\n        if (!artefato || typeof artefato === 'string') continue;\n\n        const isBinary = !!artefato.conteudo_base64;\n        const conteudo = isBinary ? artefato.conteudo_base64 : (artefato.conteudo || \"\");\n        \n        // LIMPEZA MELHORADA: Remove caracteres especiais, mas ignora o ponto por enquanto\n        let tituloLimpo = (artefato.titulo || 'arquivo')\n            .normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\") // remove acentos\n            .replace(/[^a-zA-Z0-9]/g, '_') // substitui tudo que não é letra/numero por _\n            .replace(/_{2,}/g, '_') // remove duplicatas de ______\n            .toLowerCase();\n\n        let fileName = `${artefato.id}_${tituloLimpo}`;\n\n        if (isBinary) {\n            // Lógica de assinaturas binárias\n            if (conteudo.startsWith('UEsDBB')) fileName += '.zip';\n            else if (conteudo.startsWith('iVBORw0KGgo')) fileName += '.png';\n            else if (conteudo.startsWith('/9j/')) fileName += '.jpg';\n            else if (conteudo.startsWith('JVBERi0')) fileName += '.pdf';\n            else fileName += '.bin';\n        } else {\n            // Se você acha que é Markdown, troque '.html' por '.md' abaixo\n            fileName += '.md'; \n        }\n\n        const filePath = path.join(baseDir, fileName);\n        if (isBinary) {\n            fs.writeFileSync(filePath, Buffer.from(conteudo, 'base64'));\n        } else {\n            fs.writeFileSync(filePath, conteudo);\n        }\n\n        // Salva metadados\n        const metadata = {\n            resource_id: artefato.id,\n            title: artefato.titulo,\n            filename: fileName,\n            original_url: `https://alm.serpro/rm/resources/${artefato.id}`,\n            timestamp: new Date().toISOString()\n        };\n        fs.writeFileSync(filePath + '.meta.json', JSON.stringify(metadata, null, 2));\n\n        returnItems.push({ json: { ...item.json, savedPath: filePath, generatedFileName: fileName } });\n    } catch (err) {\n        returnItems.push({ json: { skip: true, error: err.message } });\n    }\n}\nreturn returnItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        56
      ],
      "id": "1f8bce6c-88b1-4d4b-a751-88a31995a6fb",
      "name": "Salvar artefatos"
    },
    {
      "parameters": {
        "amount": 0.3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        224,
        -16
      ],
      "id": "dac1fa29-814e-4ebc-82ae-4610f9c60ddf",
      "name": "Wait1",
      "webhookId": "2bc0f5cf-c36a-4e9c-99bb-73d4bb5a6edc"
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -224,
        56
      ],
      "id": "9e503719-472a-4f75-9bc7-311ab139dbf7",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst path = require('path');\n\nconst baseDir = '/home/node/.n8n-files/requisitos/raw/';\nconst items = $input.all();\nconst itemsToDownload = [];\n\nfor (const item of items) {\n    const art = item.json;\n    \n    // A mesma lógica de limpeza do nó de salvar\n    let tituloLimpo = (art.title || 'arquivo')\n        .normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\n        .replace(/[^a-zA-Z0-9]/g, '_')\n        .replace(/_{2,}/g, '_')\n        .toLowerCase();\n\n    // Importante: Como aqui ainda não sabemos se é binário (não baixamos),\n    // vamos checar pelas duas extensões mais prováveis: .md ou .html\n    const fileNameBase = `${art.resource_id}_${tituloLimpo}`;\n    const possibleFiles = [\n        path.join(baseDir, fileNameBase + '.md'),\n        path.join(baseDir, fileNameBase + '.html'),\n        path.join(baseDir, fileNameBase + '.pdf'),\n        path.join(baseDir, fileNameBase + '.zip')\n    ];\n\n    let existingFile = possibleFiles.find(f => fs.existsSync(f));\n\n    if (existingFile) {\n        const stats = fs.statSync(existingFile);\n        const dataLocal = new Date(stats.mtime);\n        const dataRemota = new Date(art.modified);\n\n        if (dataRemota > dataLocal) {\n            itemsToDownload.push(item); // Atualização necessária\n        }\n    } else {\n        itemsToDownload.push(item); // Novo arquivo\n    }\n}\n\nreturn itemsToDownload;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        -16
      ],
      "id": "a509d8d2-711a-42f6-af49-8eb01ef142b6",
      "name": "Verificar Cache"
    }
  ],
  "pinData": {},
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Consultar Areas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Areas": {
      "main": [
        [
          {
            "node": "Parse Areas SSE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Areas SSE": {
      "main": [
        [
          {
            "node": "Listar Requisitos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Requisitos": {
      "main": [
        [
          {
            "node": "Parse Requisitos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Requisitos": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Artefato": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "tratar artefatos": {
      "main": [
        [
          {
            "node": "Verificar Cache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "download artefatos": {
      "main": [
        [
          {
            "node": "Salvar artefatos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar artefatos": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "tratar artefatos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Buscar Artefato",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Cache": {
      "main": [
        [
          {
            "node": "download artefatos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "1d12d578-56e2-4c8b-a668-709a34c390a3",
  "meta": {
    "instanceId": "dd13b4e372b9df78df1f291eee98d5307371a69a336c840770655c0b5e900808"
  },
  "id": "1SvrtJVrLaVP9nnmLSVoD",
  "tags": []
}